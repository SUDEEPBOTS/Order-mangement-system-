<!DOCTYPE html>
<html>
<head>
    <title>New Order</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 600px; margin: 0 auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea { 
            width: 100%; 
            padding: 8px; 
            box-sizing: border-box; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        button { 
            background: #4CAF50; 
            color: white; 
            padding: 10px 15px; 
            border: none; 
            cursor: pointer;
            margin-top: 10px;
        }
        #orderTimer, #orderComplete { 
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8f8f8;
            border-radius: 5px;
        }
        #timer { font-size: 24px; font-weight: bold; }
        .order-details { margin: 15px 0; }
        .order-details div { margin: 5px 0; }
        .success-message { 
            color: green;
            font-weight: bold;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h1>Create New Order</h1>
    <a href="dashboard.html" style="display: inline-block; margin-bottom: 20px;">← Back to Dashboard</a>
    
    <form id="orderForm">
        <div class="form-group">
            <label for="towerNumber">Tower Number</label>
            <input type="text" id="towerNumber" required>
        </div>
        
        <div class="form-group">
            <label for="flatNumber">Flat Number</label>
            <input type="text" id="flatNumber" required>
        </div>
        
        <div class="form-group">
            <label for="orderDetails">Order Details</label>
            <textarea id="orderDetails" rows="4" required></textarea>
        </div>
        
        <button type="submit">Submit Order</button>
    </form>
    
    <div id="orderTimer">
        <h3>Order In Progress</h3>
        <p>Tracking Number: <strong id="trackingNumber"></strong></p>
        <div id="timer">00:00:00</div>
        <button id="completeOrderBtn">Mark as Delivered</button>
    </div>

    <div id="orderComplete">
        <div class="success-message">✅ Order Successfully Completed!</div>
        <div class="order-details">
            <div><strong>Completion Time:</strong> <span id="completeTime"></span></div>
            <div><strong>Delivery Address:</strong> Tower <span id="completeTower"></span>, Flat <span id="completeFlat"></span></div>
            <div><strong>Tracking Number:</strong> <span id="completeTracking"></span></div>
            <div><strong>Time Taken:</strong> <span id="completeDuration"></span></div>
        </div>
        <button onclick="window.location.href='dashboard.html'">Back to Dashboard</button>
        <button onclick="window.location.href='order-history.html'">View Order History</button>
    </div>

    <script>
        // Initialize app data if not exists
        if (!localStorage.getItem('appData')) {
            localStorage.setItem('appData', JSON.stringify({
                allOrders: []
            }));
        }

        document.getElementById('orderForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get form values
            const towerNumber = document.getElementById('towerNumber').value;
            const flatNumber = document.getElementById('flatNumber').value;
            const orderDetails = document.getElementById('orderDetails').value;
            
            // Generate tracking number
            const trackingNumber = 'TRK-' + Math.floor(100000 + Math.random() * 900000);
            
            // Create order object
            const newOrder = {
                username: localStorage.getItem('currentUser'),
                towerNumber,
                flatNumber,
                orderDetails,
                trackingNumber,
                status: 'In Progress',
                createdAt: new Date().toISOString(),
                startTime: new Date().getTime(),
                completedAt: null,
                duration: null
            };
            
            // Save to global storage
            const appData = JSON.parse(localStorage.getItem('appData'));
            appData.allOrders.push(newOrder);
            localStorage.setItem('appData', JSON.stringify(appData));
            
            // Update display
            document.getElementById('orderForm').style.display = 'none';
            document.getElementById('orderTimer').style.display = 'block';
            document.getElementById('trackingNumber').textContent = trackingNumber;
            
            // Start timer
            startTimer(newOrder.startTime, trackingNumber);
        });
        
        // Timer function
        function startTimer(startTime, trackingNumber) {
            const timerElement = document.getElementById('timer');
            let timerInterval;
            
            function updateTimer() {
                const now = new Date().getTime();
                const elapsed = Math.floor((now - startTime) / 1000);
                
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const seconds = elapsed % 60;
                
                timerElement.textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
            
            // Complete order button
            document.getElementById('completeOrderBtn').addEventListener('click', function() {
                clearInterval(timerInterval);
                
                const endTime = new Date().getTime();
                const durationSeconds = Math.floor((endTime - startTime) / 1000);
                
                // Format duration
                const hours = Math.floor(durationSeconds / 3600);
                const minutes = Math.floor((durationSeconds % 3600) / 60);
                const seconds = durationSeconds % 60;
                const formattedDuration = `${hours}h ${minutes}m ${seconds}s`;
                
                // Update order in global storage
                const appData = JSON.parse(localStorage.getItem('appData'));
                const orderIndex = appData.allOrders.findIndex(o => o.trackingNumber === trackingNumber);
                
                if (orderIndex !== -1) {
                    appData.allOrders[orderIndex].status = 'Delivered';
                    appData.allOrders[orderIndex].completedAt = new Date().toISOString();
                    appData.allOrders[orderIndex].duration = formattedDuration;
                    localStorage.setItem('appData', JSON.stringify(appData));
                    
                    // Show completion details
                    document.getElementById('orderTimer').style.display = 'none';
                    document.getElementById('orderComplete').style.display = 'block';
                    
                    document.getElementById('completeTime').textContent = new Date().toLocaleString();
                    document.getElementById('completeTower').textContent = appData.allOrders[orderIndex].towerNumber;
                    document.getElementById('completeFlat').textContent = appData.allOrders[orderIndex].flatNumber;
                    document.getElementById('completeTracking').textContent = trackingNumber;
                    document.getElementById('completeDuration').textContent = formattedDuration;
                }
            });
        }
    </script>
</body>
</html>
